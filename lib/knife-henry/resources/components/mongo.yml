---
name: mongo
berks: |
  cookbook 'mongodb', git: 'https://github.com/edelight/chef-mongodb'
role: |
  name 'mongo'

  default_attributes(
    'mongodb' => {
      'package_version' => '2.4.7',
      'bind_ip' => '127.0.0.1',
      'logpath' => '/var/log/mongodb',
      'dbpath' => '/srv/data/mongodb',
    }
  )
  
  run_list %w{
    recipe[mongodb::10gen_repo]
    recipe[mongodb]
    recipe[<%= @cookbook %>::mongo]
  }
recipe: |
  mongod_init = "#{node.mongodb.init_dir}/#{node.mongodb.instance_name}"

  monit_d 'mongo' do
    service_type "process"
    service_id "#{node.mongodb.dbpath}/mongod.lock"
    service_group "mongo"
    start_command "#{mongod_init} start"
    stop_command "#{mongod_init} stop"
    service_tests [
      {
        'condition' => "if failed port #{node.mongodb.port} proto http for 2 cycles",
        'action' => "restart"
      },
      {
        'condition' => "if 3 restarts within 10 cycles",
        'action' => "timeout"
      }
    ]
  end
